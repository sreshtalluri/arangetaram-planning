---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/lib/query-client.ts
  - frontend/src/hooks/useProfile.ts
  - frontend/src/index.js
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "React Query is configured with appropriate staleTime"
    - "QueryClientProvider wraps the app"
    - "useProfile hook fetches user profile from Supabase"
    - "Profile data is cached and refetched appropriately"
  artifacts:
    - path: "frontend/src/lib/query-client.ts"
      provides: "Configured QueryClient instance"
      exports: ["queryClient"]
      min_lines: 10
    - path: "frontend/src/hooks/useProfile.ts"
      provides: "Profile fetching hook"
      exports: ["useProfile"]
      min_lines: 20
  key_links:
    - from: "frontend/src/hooks/useProfile.ts"
      to: "frontend/src/lib/supabase.ts"
      via: "supabase client for database query"
      pattern: "supabase.from.*profiles"
    - from: "frontend/src/index.js"
      to: "frontend/src/lib/query-client.ts"
      via: "QueryClientProvider wrapper"
      pattern: "QueryClientProvider"
---

<objective>
Set up React Query for server state management with QueryClient and create useProfile hook.

Purpose: React Query provides caching, loading states, and error handling for Supabase queries. The useProfile hook will be used by components to access user profile data with proper caching.

Output: QueryClient configured, useProfile hook ready for use in components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@frontend/src/lib/database.types.ts
@frontend/src/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Query and create QueryClient</name>
  <files>
    - frontend/package.json
    - frontend/src/lib/query-client.ts
  </files>
  <action>
1. Install TanStack Query:
   `cd frontend && yarn add @tanstack/react-query`

2. Create `frontend/src/lib/query-client.ts`:
   ```typescript
   import { QueryClient } from '@tanstack/react-query'

   export const queryClient = new QueryClient({
     defaultOptions: {
       queries: {
         staleTime: 60 * 1000, // 1 minute - data considered fresh
         gcTime: 5 * 60 * 1000, // 5 minutes - cache retention (formerly cacheTime)
         retry: 1, // Retry failed requests once
         refetchOnWindowFocus: true, // Refetch when tab regains focus
       },
     },
   })
   ```

Note: gcTime replaced cacheTime in TanStack Query v5.
  </action>
  <verify>
- `yarn --cwd frontend list @tanstack/react-query` shows package installed
- `cat frontend/src/lib/query-client.ts` shows QueryClient with defaultOptions
  </verify>
  <done>React Query installed and QueryClient configured with sensible defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create useProfile hook</name>
  <files>frontend/src/hooks/useProfile.ts</files>
  <action>
Create `frontend/src/hooks/useProfile.ts` following research pattern:

```typescript
import { useQuery } from '@tanstack/react-query'
import { supabase } from '../lib/supabase'
import type { Database } from '../lib/database.types'

type Profile = Database['public']['Tables']['profiles']['Row']

export function useProfile(userId: string | undefined) {
  return useQuery({
    queryKey: ['profile', userId],
    queryFn: async (): Promise<Profile | null> => {
      if (!userId) return null

      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single()

      if (error) {
        // PGRST116 = no rows returned (user hasn't completed profile yet)
        if (error.code === 'PGRST116') {
          return null
        }
        throw error
      }
      return data
    },
    enabled: !!userId, // Only run query if userId exists
    staleTime: 60 * 1000, // Profile changes infrequently
  })
}

// Export Profile type for consumers
export type { Profile }
```

Key points:
- Uses Database types for type safety
- enabled: !!userId prevents query when not logged in
- Handles "no rows" gracefully (profile might not exist yet)
- Returns null for undefined userId (guest users)
  </action>
  <verify>
- `cat frontend/src/hooks/useProfile.ts` shows useQuery with profile fetch
- `grep "queryKey.*profile" frontend/src/hooks/useProfile.ts` finds the query key
  </verify>
  <done>useProfile hook fetches user profile with caching and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Wrap app with QueryClientProvider</name>
  <files>frontend/src/index.js</files>
  <action>
Update `frontend/src/index.js` to wrap the app with QueryClientProvider:

1. Read existing index.js content
2. Add imports:
   ```javascript
   import { QueryClientProvider } from '@tanstack/react-query'
   import { queryClient } from './lib/query-client'
   ```

3. Wrap existing content with QueryClientProvider:
   ```javascript
   <QueryClientProvider client={queryClient}>
     <AuthProvider>
       <App />
     </AuthProvider>
   </QueryClientProvider>
   ```

Preserve existing structure - just add the QueryClientProvider wrapper around AuthProvider.

Note: The existing AuthProvider from lib/auth.js will be replaced in Plan 04, but for now keep it working to avoid breaking the app during migration.
  </action>
  <verify>
- `grep "QueryClientProvider" frontend/src/index.js` finds the provider
- `grep "queryClient" frontend/src/index.js` finds the import
- `cd frontend && yarn start` launches without errors (quick check, can Ctrl+C immediately)
  </verify>
  <done>App wrapped with QueryClientProvider, React Query ready for use</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `@tanstack/react-query` in package.json dependencies
2. QueryClient exported from lib/query-client.ts
3. useProfile hook exported from hooks/useProfile.ts
4. QueryClientProvider wrapping app in index.js
5. App still starts without errors
</verification>

<success_criteria>
- React Query v5 installed and configured
- QueryClient uses gcTime (not deprecated cacheTime)
- useProfile hook uses Database types for type safety
- App wrapped with QueryClientProvider at root level
- Existing functionality preserved (app still runs)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
