---
phase: 01-foundation-authentication
plan: 06
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - frontend/src/components/Navbar.jsx
  - frontend/src/components/GuestPrompt.tsx
  - frontend/src/lib/api.js
  - frontend/src/pages/UserDashboard.jsx
  - frontend/src/pages/VendorDashboard.jsx
  - frontend/src/App.js
autonomous: true

must_haves:
  truths:
    - "Guest can browse vendors without creating account"
    - "Guest sees contextual signup prompts when attempting protected actions"
    - "User can log out from any page via Navbar"
    - "Dashboard pages are protected routes"
    - "Old FastAPI auth code is removed from api.js"
  artifacts:
    - path: "frontend/src/components/GuestPrompt.tsx"
      provides: "Reusable prompt for unauthenticated users"
      exports: ["GuestPrompt"]
      min_lines: 30
    - path: "frontend/src/components/Navbar.jsx"
      provides: "Updated navbar with Supabase logout"
      contains: "signOut"
  key_links:
    - from: "frontend/src/components/Navbar.jsx"
      to: "frontend/src/hooks/useAuth.ts"
      via: "auth state and signOut"
      pattern: "useAuth"
    - from: "frontend/src/pages/UserDashboard.jsx"
      to: "frontend/src/components/ProtectedRoute.tsx"
      via: "route wrapper in App.js"
      pattern: "ProtectedRoute"
---

<objective>
Implement guest browsing experience, logout from Navbar, protected dashboard routes, and clean up old auth code.

Purpose: Complete the auth migration by ensuring guests can browse freely, protected pages require authentication, and legacy FastAPI auth code is removed.

Output: Working guest experience with contextual prompts, protected dashboards, clean api.js without auth interceptors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@frontend/src/components/Navbar.jsx
@frontend/src/lib/api.js
@frontend/src/pages/UserDashboard.jsx
@frontend/src/pages/VendorDashboard.jsx
@frontend/src/hooks/useAuth.ts
@frontend/src/components/ProtectedRoute.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Navbar with Supabase auth and create GuestPrompt</name>
  <files>
    - frontend/src/components/Navbar.jsx
    - frontend/src/components/GuestPrompt.tsx
  </files>
  <action>
1. Update `frontend/src/components/Navbar.jsx`:

Replace auth import and usage:
```jsx
// Remove: import { useAuth } from '../lib/auth'
import { useAuth } from '../hooks/useAuth'
```

Update the logout handler:
```jsx
const { user, isAuthenticated, isVendor, signOut, loading } = useAuth()

const handleLogout = async () => {
  await signOut()
  navigate('/')
}
```

Update conditional rendering:
- Show Login/Sign Up buttons when !isAuthenticated
- Show Dashboard link and Logout button when isAuthenticated
- Show "Vendor Dashboard" link when isVendor
- Update Sign Up link to /signup
- Update Login link to /login

2. Create `frontend/src/components/GuestPrompt.tsx`:

Reusable component for contextual signup prompts per CONTEXT.md:
```typescript
import { Link } from 'react-router-dom'
import { Button } from './ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './ui/card'

interface GuestPromptProps {
  action: string // e.g., "save this vendor", "create an event", "contact vendors"
  inline?: boolean // true for inline prompts, false for card-style
}

export function GuestPrompt({ action, inline = false }: GuestPromptProps) {
  if (inline) {
    return (
      <span className="text-sm text-muted-foreground">
        <Link to="/signup" className="text-primary hover:underline">
          Sign up
        </Link>
        {' '}to {action}
      </span>
    )
  }

  return (
    <Card className="max-w-md mx-auto">
      <CardHeader>
        <CardTitle>Create an Account</CardTitle>
        <CardDescription>
          Sign up to {action}
        </CardDescription>
      </CardHeader>
      <CardContent className="flex flex-col gap-4">
        <Button asChild>
          <Link to="/signup">Sign Up</Link>
        </Button>
        <p className="text-sm text-center text-muted-foreground">
          Already have an account?{' '}
          <Link to="/login" className="text-primary hover:underline">
            Log in
          </Link>
        </p>
      </CardContent>
    </Card>
  )
}
```

Usage examples:
- `<GuestPrompt action="save this vendor" inline />` - in vendor card
- `<GuestPrompt action="create an event" />` - on plan event page when not logged in
  </action>
  <verify>
- `grep "useAuth.*hooks" frontend/src/components/Navbar.jsx` finds new import
- `grep "signOut" frontend/src/components/Navbar.jsx` finds logout handler
- `cat frontend/src/components/GuestPrompt.tsx` shows both inline and card variants
  </verify>
  <done>Navbar uses Supabase auth with logout, GuestPrompt provides contextual signup prompts</done>
</task>

<task type="auto">
  <name>Task 2: Protect dashboard routes and update dashboards</name>
  <files>
    - frontend/src/pages/UserDashboard.jsx
    - frontend/src/pages/VendorDashboard.jsx
    - frontend/src/App.js
  </files>
  <action>
1. Update `frontend/src/App.js` to wrap dashboard routes with ProtectedRoute:

```jsx
import { ProtectedRoute } from './components/ProtectedRoute'

// In Routes:
<Route
  path="/dashboard"
  element={
    <ProtectedRoute>
      <UserDashboard />
    </ProtectedRoute>
  }
/>
<Route
  path="/vendor/dashboard"
  element={
    <ProtectedRoute requiredRole="vendor">
      <VendorDashboard />
    </ProtectedRoute>
  }
/>
```

2. Update `frontend/src/pages/UserDashboard.jsx`:

Replace auth import:
```jsx
// Remove: import { useAuth } from '../lib/auth'
import { useAuth } from '../hooks/useAuth'
```

Update to use new auth shape:
```jsx
const { user, profile, loading } = useAuth()

// Use profile.full_name or user.email for display
```

3. Update `frontend/src/pages/VendorDashboard.jsx`:

Same pattern - replace auth import and update usage.

Note: These dashboards may still use old API calls for data. That's OK - we're just fixing auth. Data fetching will remain via existing api.js vendorAPI/eventAPI calls for now.
  </action>
  <verify>
- `grep "ProtectedRoute" frontend/src/App.js` finds protected route wrappers
- `grep "requiredRole.*vendor" frontend/src/App.js` finds vendor role check
- `grep "useAuth.*hooks" frontend/src/pages/UserDashboard.jsx` finds new import
  </verify>
  <done>Dashboard routes protected, dashboards use new auth hook</done>
</task>

<task type="auto">
  <name>Task 3: Clean up old auth code from api.js</name>
  <files>
    - frontend/src/lib/api.js
    - frontend/src/lib/auth.js.bak
  </files>
  <action>
1. Update `frontend/src/lib/api.js`:

Remove auth-related code:
- Remove `authAPI` object (register, login, logout, createGuest, getCurrentUser)
- Remove Authorization header interceptor (Supabase handles this)
- Remove 401 response interceptor (Supabase handles token refresh)
- Keep vendorAPI, eventAPI, bookingAPI, aiAPI, categoryAPI, seedAPI

The axios instance can remain for non-auth API calls (if any exist), but remove:
```javascript
// REMOVE this:
api.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// REMOVE this:
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

// REMOVE authAPI entirely
```

2. Confirm auth.js.bak exists (created in Plan 04). If not, back it up now:
   `mv frontend/src/lib/auth.js frontend/src/lib/auth.js.bak`

3. Create empty placeholder at old auth path to catch stale imports:
   `frontend/src/lib/auth.js`:
```javascript
// DEPRECATED: This file has been replaced by Supabase auth.
// Use: import { useAuth } from '../hooks/useAuth'
// See: frontend/src/contexts/AuthContext.tsx

throw new Error(
  'auth.js is deprecated. Import useAuth from hooks/useAuth instead. ' +
  'See auth.js.bak for the original implementation.'
);
```

This ensures any remaining imports fail loudly with guidance.
  </action>
  <verify>
- `grep "authAPI" frontend/src/lib/api.js` returns nothing (removed)
- `grep "interceptors" frontend/src/lib/api.js` returns nothing (removed)
- `cat frontend/src/lib/auth.js` shows deprecation error
- `ls frontend/src/lib/auth.js.bak` confirms backup exists
  </verify>
  <done>Old auth code removed from api.js, deprecated auth.js throws helpful error</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Can browse /vendors without login (guest browsing works)
2. Clicking "Dashboard" when not logged in redirects to /login
3. After login, can access /dashboard
4. Logout button in navbar works and redirects to home
5. /vendor/dashboard only accessible with vendor role
6. No console errors about missing auth imports
</verification>

<success_criteria>
- Guest can browse all public pages (vendors, vendor detail) without account
- Protected pages (dashboard, plan event) redirect to login
- Navbar logout uses signOut and redirects appropriately
- Old authAPI removed from api.js
- Stale auth.js imports fail with helpful error message
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-06-SUMMARY.md`
</output>
