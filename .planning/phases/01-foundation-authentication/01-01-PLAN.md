---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00001_profiles.sql
  - supabase/config.toml
  - .env.example
  - frontend/.env
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication infrastructure"
    env_vars:
      - name: REACT_APP_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: REACT_APP_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Create new Supabase project"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable email auth with email verification required"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"

must_haves:
  truths:
    - "Supabase project is created and accessible"
    - "Database has profiles table with role column"
    - "New user signup automatically creates profile record"
    - "Row Level Security is enabled on profiles table"
    - "TypeScript types are generated from schema"
  artifacts:
    - path: "supabase/migrations/00001_profiles.sql"
      provides: "Profiles table, trigger, RLS policies"
      contains: "CREATE TABLE public.profiles"
    - path: "supabase/config.toml"
      provides: "Supabase CLI configuration"
      contains: "project_id"
    - path: ".env.example"
      provides: "Required environment variables template"
      contains: "REACT_APP_SUPABASE_URL"
    - path: "frontend/src/lib/database.types.ts"
      provides: "Generated TypeScript types"
      contains: "Database"
  key_links:
    - from: "supabase/migrations/00001_profiles.sql"
      to: "auth.users"
      via: "foreign key and trigger"
      pattern: "REFERENCES auth.users"
---

<objective>
Set up Supabase infrastructure with database schema, Row Level Security policies, and TypeScript type generation.

Purpose: Establish the foundation for secure multi-tenant data access and type-safe database operations. This is the first step of the Supabase migration - without this, nothing else can proceed.

Output: Supabase project linked, profiles table with RLS, TypeScript types generated from schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/codebase/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase CLI and create migration</name>
  <files>
    - supabase/config.toml
    - supabase/migrations/00001_profiles.sql
    - .env.example
  </files>
  <action>
1. Install Supabase CLI globally: `npm install -g supabase`
2. Initialize Supabase in project root: `supabase init`
3. Create .env.example with required variables:
   ```
   REACT_APP_SUPABASE_URL=your-project-url
   REACT_APP_SUPABASE_ANON_KEY=your-anon-key
   ```
4. Create migration file `supabase/migrations/00001_profiles.sql` with:
   - profiles table (id UUID PK references auth.users, role TEXT with CHECK constraint for 'user'/'vendor', email TEXT NOT NULL, full_name TEXT, created_at TIMESTAMPTZ, updated_at TIMESTAMPTZ)
   - Enable RLS immediately after table creation
   - Trigger function `handle_new_user()` that creates profile from raw_user_meta_data
   - Trigger on auth.users AFTER INSERT
   - RLS policies:
     - "Public vendor profiles readable" - SELECT where role = 'vendor'
     - "Users can read own profile" - SELECT where auth.uid() = id
     - "Users can update own profile" - UPDATE where auth.uid() = id
   - Index on profiles(id) for RLS performance

Use the exact SQL patterns from 01-RESEARCH.md Pattern 3 and Pattern 4.
  </action>
  <verify>
- `ls supabase/config.toml` shows file exists
- `cat supabase/migrations/00001_profiles.sql` shows complete SQL with table, trigger, RLS
- `cat .env.example` shows REACT_APP_SUPABASE_URL and REACT_APP_SUPABASE_ANON_KEY
  </verify>
  <done>Migration file exists with profiles table, trigger, and RLS policies ready for deployment</done>
</task>

<task type="auto">
  <name>Task 2: Link Supabase project and apply migration</name>
  <files>
    - supabase/.gitignore
    - frontend/.env
  </files>
  <action>
1. Link to remote Supabase project: `supabase link --project-ref <project-ref>`
   - Get project-ref from Supabase Dashboard -> Project Settings -> General -> Reference ID
   - This requires user to have created the project first (user_setup)

2. Push migration to remote: `supabase db push`
   - This applies the migration to the remote database
   - Verify no errors in output

3. Update frontend/.env with actual values:
   - Copy from Supabase Dashboard -> Project Settings -> API
   - REACT_APP_SUPABASE_URL=https://[project-ref].supabase.co
   - REACT_APP_SUPABASE_ANON_KEY=[anon key from dashboard]

4. Add supabase/.gitignore to exclude sensitive files:
   ```
   .branches
   .temp
   ```

Note: If `supabase link` fails with auth error, prompt user to run `supabase login` first.
  </action>
  <verify>
- `supabase db push` completes without errors
- Supabase Dashboard -> Table Editor shows profiles table
- Supabase Dashboard -> Authentication -> Policies shows RLS enabled on profiles
  </verify>
  <done>Migration applied to remote Supabase, profiles table exists with RLS enabled</done>
</task>

<task type="auto">
  <name>Task 3: Generate TypeScript types from database schema</name>
  <files>
    - frontend/src/lib/database.types.ts
    - frontend/package.json
  </files>
  <action>
1. Install Supabase JS client: `cd frontend && yarn add @supabase/supabase-js`

2. Generate types from remote schema:
   `supabase gen types typescript --project-id <project-ref> > frontend/src/lib/database.types.ts`

3. Verify generated file contains:
   - Database interface with public schema
   - Tables.profiles type with Row, Insert, Update variants
   - Proper typing for role column

4. Add npm script to package.json for regenerating types:
   ```json
   "scripts": {
     "gen:types": "supabase gen types typescript --project-id <project-ref> > src/lib/database.types.ts"
   }
   ```

Note: The existing frontend uses Create React App with yarn, not npm. Use yarn for all package operations.
  </action>
  <verify>
- `cat frontend/src/lib/database.types.ts | head -50` shows Database interface
- `grep "profiles" frontend/src/lib/database.types.ts` shows profiles table types
- `yarn --cwd frontend list @supabase/supabase-js` shows package installed
  </verify>
  <done>TypeScript types generated from database schema, Supabase client installed</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `supabase status` shows linked project
2. Supabase Dashboard shows profiles table with RLS enabled
3. `frontend/src/lib/database.types.ts` exists with Database interface
4. `@supabase/supabase-js` is in frontend/package.json dependencies
</verification>

<success_criteria>
- Supabase CLI initialized and linked to remote project
- Migration file exists with profiles table, trigger, and RLS policies
- Migration applied to remote database successfully
- TypeScript types generated from schema
- Environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
