---
phase: 02-vendor-supply-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00002_vendor_tables.sql
  - frontend/src/lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Vendor profiles table exists with all required fields"
    - "Portfolio images table exists with order_index column"
    - "Vendor availability table exists with DATE type for blocked_date"
    - "RLS policies prevent unauthorized access"
    - "Storage bucket exists for portfolio images"
  artifacts:
    - path: "supabase/migrations/00002_vendor_tables.sql"
      provides: "Database schema for vendor platform"
      contains: "CREATE TABLE public.vendor_profiles"
    - path: "frontend/src/lib/database.types.ts"
      provides: "Updated TypeScript types"
      contains: "vendor_profiles"
  key_links:
    - from: "vendor_profiles.id"
      to: "profiles.id"
      via: "REFERENCES public.profiles(id)"
      pattern: "REFERENCES public.profiles"
---

<objective>
Create database schema for vendor platform with vendor_profiles, portfolio_images, and vendor_availability tables, plus Supabase Storage bucket for portfolio images.

Purpose: Establishes the data foundation for all vendor-related features - profiles, portfolios, and availability management.
Output: Migration applied, RLS policies active, Storage bucket created, TypeScript types regenerated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vendor-supply-platform/02-RESEARCH.md

@frontend/src/lib/database.types.ts
@supabase/migrations/00001_profiles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vendor tables migration</name>
  <files>supabase/migrations/00002_vendor_tables.sql</files>
  <action>
Create migration file with:

1. **vendor_profiles table:**
   - id: UUID PRIMARY KEY, REFERENCES profiles(id) ON DELETE CASCADE
   - business_name: TEXT NOT NULL
   - description: TEXT
   - category: TEXT NOT NULL with CHECK constraint for 11 categories: venue, catering, photography, videography, stage_decoration, musicians, nattuvanar, makeup_artist, invitations, costumes, return_gifts
   - service_areas: TEXT[] DEFAULT '{}'
   - price_min: INTEGER (nullable)
   - price_max: INTEGER (nullable)
   - profile_photo_url: TEXT (nullable)
   - is_published: BOOLEAN DEFAULT false
   - created_at: TIMESTAMPTZ DEFAULT NOW()
   - updated_at: TIMESTAMPTZ DEFAULT NOW()

2. **portfolio_images table:**
   - id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - vendor_id: UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE
   - storage_path: TEXT NOT NULL
   - caption: TEXT (nullable)
   - order_index: INTEGER NOT NULL
   - created_at: TIMESTAMPTZ DEFAULT NOW()

3. **vendor_availability table:**
   - id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - vendor_id: UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE
   - blocked_date: DATE NOT NULL (use DATE type, not TIMESTAMP)
   - note: TEXT (nullable, for vendor's private notes)
   - created_at: TIMESTAMPTZ DEFAULT NOW()
   - UNIQUE(vendor_id, blocked_date)

4. **RLS Policies:**
   - Enable RLS on all three tables
   - vendor_profiles: Public can SELECT where is_published=true, vendors can CRUD own row
   - portfolio_images: Public can SELECT all, vendors can manage own images
   - vendor_availability: Public can SELECT all, vendors can manage own dates

5. **Update trigger for updated_at:**
   - Create trigger on vendor_profiles to auto-update updated_at column

6. **Storage bucket creation (via Supabase dashboard SQL or API):**
   - Add comment in migration noting that storage bucket 'portfolio-images' must be created via dashboard
   - Include SQL comment with RLS policy examples for storage
  </action>
  <verify>
File exists at supabase/migrations/00002_vendor_tables.sql with all CREATE TABLE statements, RLS policies, and CHECK constraints.
  </verify>
  <done>
Migration file ready with vendor_profiles (11 category constraint), portfolio_images (order_index), vendor_availability (DATE type), and RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and regenerate types</name>
  <files>frontend/src/lib/database.types.ts</files>
  <action>
1. Push migration to Supabase:
   ```bash
   npx supabase db push
   ```

2. Create storage bucket via Supabase CLI:
   ```bash
   # Create portfolio-images bucket (public for reading)
   npx supabase storage create portfolio-images --public
   ```
   If CLI doesn't support storage create, note that user must create via dashboard.

3. Regenerate TypeScript types:
   ```bash
   cd frontend && npm run gen:types
   ```

4. Verify types include vendor_profiles, portfolio_images, vendor_availability tables with correct column types.
  </action>
  <verify>
- `npx supabase db push` succeeds
- frontend/src/lib/database.types.ts contains vendor_profiles, portfolio_images, vendor_availability types
- Types show category as TEXT, blocked_date as string (DATE type), order_index as number
  </verify>
  <done>
Migration applied to remote database, TypeScript types regenerated with all vendor tables.
  </done>
</task>

</tasks>

<verification>
1. Check database.types.ts has vendor_profiles type with is_published boolean
2. Check database.types.ts has portfolio_images type with order_index number
3. Check database.types.ts has vendor_availability type with blocked_date string
4. Supabase dashboard shows all three tables with RLS enabled
</verification>

<success_criteria>
- Migration 00002_vendor_tables.sql exists and applied
- TypeScript types include all three new tables
- RLS policies are active (check Supabase dashboard)
- vendor_profiles has category CHECK constraint with 11 values
</success_criteria>

<output>
After completion, create `.planning/phases/02-vendor-supply-platform/02-01-SUMMARY.md`
</output>
