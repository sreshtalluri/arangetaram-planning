---
phase: 02-vendor-supply-platform
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/lib/storage.ts
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "Portfolio images can be uploaded to Supabase Storage"
    - "Images are organized in vendor-specific folders"
    - "File size validated before upload (< 5MB)"
    - "Public URLs can be retrieved for display"
    - "dnd-kit is available for drag-drop functionality"
  artifacts:
    - path: "frontend/src/lib/storage.ts"
      provides: "Storage upload and URL helpers"
      exports: ["uploadPortfolioImage", "deletePortfolioImage", "getPublicUrl"]
    - path: "frontend/package.json"
      provides: "dnd-kit dependencies"
      contains: "@dnd-kit/core"
  key_links:
    - from: "frontend/src/lib/storage.ts"
      to: "Supabase Storage"
      via: "supabase.storage.from('portfolio-images')"
      pattern: "storage\\.from\\('portfolio-images'\\)"
---

<objective>
Install dnd-kit for drag-drop reordering and create storage helpers for portfolio image upload/delete operations.

Purpose: Provides the infrastructure for portfolio management - image uploads with validation and drag-to-reorder capability.
Output: Storage utilities ready and dnd-kit available for portfolio components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-vendor-supply-platform/02-RESEARCH.md

@frontend/src/lib/supabase.ts
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit packages</name>
  <files>frontend/package.json</files>
  <action>
Install dnd-kit for drag-drop portfolio reordering:

```bash
cd frontend && npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities --legacy-peer-deps
```

Use --legacy-peer-deps to handle the existing date-fns peer dependency conflict.

Verify installation in package.json:
- @dnd-kit/core should be ^6.x
- @dnd-kit/sortable should be ^8.x or ^9.x
- @dnd-kit/utilities should be ^3.x
  </action>
  <verify>
- package.json contains @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
- npm install completed without errors
  </verify>
  <done>
dnd-kit packages installed and available for portfolio drag-drop implementation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create storage upload helpers</name>
  <files>frontend/src/lib/storage.ts</files>
  <action>
Create storage.ts with portfolio image upload utilities:

```typescript
import { supabase } from './supabase'

const PORTFOLIO_BUCKET = 'portfolio-images'
const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp']

export interface UploadResult {
  path: string
  url: string
}

export class StorageError extends Error {
  constructor(message: string, public code: string) {
    super(message)
    this.name = 'StorageError'
  }
}

/**
 * Validate file before upload
 */
function validateFile(file: File): void {
  if (file.size > MAX_FILE_SIZE) {
    throw new StorageError(
      'Image too large. Please use an image under 5MB.',
      'FILE_TOO_LARGE'
    )
  }
  if (!ALLOWED_TYPES.includes(file.type)) {
    throw new StorageError(
      'Invalid file type. Please use JPEG, PNG, or WebP.',
      'INVALID_TYPE'
    )
  }
}

/**
 * Upload a portfolio image for a vendor
 * Images are stored in vendor-specific folders: {vendorId}/{filename}
 */
export async function uploadPortfolioImage(
  vendorId: string,
  file: File,
  orderIndex: number
): Promise<UploadResult> {
  validateFile(file)

  // Generate unique filename with order prefix for sorting
  const ext = file.name.split('.').pop()?.toLowerCase() || 'jpg'
  const fileName = `${orderIndex}-${Date.now()}.${ext}`
  const filePath = `${vendorId}/${fileName}`

  const { error: uploadError } = await supabase.storage
    .from(PORTFOLIO_BUCKET)
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: false,
    })

  if (uploadError) {
    console.error('Upload error:', uploadError)
    throw new StorageError(
      'Failed to upload image. Please try again.',
      'UPLOAD_FAILED'
    )
  }

  const url = getPublicUrl(filePath)
  return { path: filePath, url }
}

/**
 * Delete a portfolio image from storage
 */
export async function deletePortfolioImage(storagePath: string): Promise<void> {
  const { error } = await supabase.storage
    .from(PORTFOLIO_BUCKET)
    .remove([storagePath])

  if (error) {
    console.error('Delete error:', error)
    throw new StorageError(
      'Failed to delete image. Please try again.',
      'DELETE_FAILED'
    )
  }
}

/**
 * Get public URL for a portfolio image
 * Note: Supabase Image Transforms require Pro plan
 * Using basic public URL for now
 */
export function getPublicUrl(storagePath: string): string {
  const { data } = supabase.storage
    .from(PORTFOLIO_BUCKET)
    .getPublicUrl(storagePath)

  return data.publicUrl
}

/**
 * Upload a profile photo for a vendor
 * Stored at: {vendorId}/profile.{ext}
 */
export async function uploadProfilePhoto(
  vendorId: string,
  file: File
): Promise<string> {
  validateFile(file)

  const ext = file.name.split('.').pop()?.toLowerCase() || 'jpg'
  const filePath = `${vendorId}/profile.${ext}`

  const { error } = await supabase.storage
    .from(PORTFOLIO_BUCKET)
    .upload(filePath, file, {
      cacheControl: '3600',
      upsert: true, // Allow replacing profile photo
    })

  if (error) {
    throw new StorageError(
      'Failed to upload profile photo. Please try again.',
      'UPLOAD_FAILED'
    )
  }

  return getPublicUrl(filePath)
}

// Export constants for use in components
export { MAX_FILE_SIZE, ALLOWED_TYPES, PORTFOLIO_BUCKET }
```
  </action>
  <verify>
- File exists at frontend/src/lib/storage.ts
- Exports uploadPortfolioImage, deletePortfolioImage, getPublicUrl
- File size validation at 5MB
- Uses supabase.storage.from('portfolio-images')
- Stores images in vendor-specific folders
  </verify>
  <done>
Storage utilities ready with upload validation, vendor folder structure, and public URL generation.
  </done>
</task>

</tasks>

<verification>
1. package.json includes @dnd-kit/core, @dnd-kit/sortable, @dnd-kit/utilities
2. storage.ts exports uploadPortfolioImage function
3. MAX_FILE_SIZE is 5MB (5 * 1024 * 1024)
4. ALLOWED_TYPES includes jpeg, png, webp
5. Files stored in {vendorId}/{filename} path structure
</verification>

<success_criteria>
- dnd-kit packages installed (check package.json dependencies)
- storage.ts compiles without TypeScript errors
- uploadPortfolioImage validates file size and type before upload
- File paths follow vendor-folder structure
</success_criteria>

<output>
After completion, create `.planning/phases/02-vendor-supply-platform/02-03-SUMMARY.md`
</output>
