---
phase: 03-event-planning-discovery
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/hooks/useVendors.ts
  - frontend/src/hooks/useDiscoveryFilters.ts
  - frontend/src/components/discovery/FilterSidebar.tsx
  - frontend/src/components/discovery/VendorGrid.tsx
  - frontend/src/pages/VendorsPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can filter vendors by category"
    - "User can filter vendors by location/metro area"
    - "User can filter vendors by price range"
    - "User can filter vendors by availability for a specific date"
    - "User can search vendors by name or keyword"
    - "Filter state persists in URL for shareable links"
  artifacts:
    - path: "frontend/src/hooks/useDiscoveryFilters.ts"
      provides: "URL param sync for filters"
      exports: ["useDiscoveryFilters"]
    - path: "frontend/src/hooks/useVendors.ts"
      provides: "Extended with availability filtering"
      exports: ["useVendors", "useVendorById"]
    - path: "frontend/src/components/discovery/FilterSidebar.tsx"
      provides: "Left sidebar filter controls"
      min_lines: 100
    - path: "frontend/src/pages/VendorsPage.jsx"
      provides: "Rebuilt with sidebar layout"
      min_lines: 80
  key_links:
    - from: "frontend/src/pages/VendorsPage.jsx"
      to: "frontend/src/hooks/useDiscoveryFilters.ts"
      via: "useDiscoveryFilters hook"
      pattern: "useDiscoveryFilters"
    - from: "frontend/src/hooks/useVendors.ts"
      to: "vendor_availability table"
      via: "availability date filter"
      pattern: "vendor_availability"
---

<objective>
Rebuild VendorsPage with left sidebar filter layout and add location + availability filters.

Purpose: Enable users to discover vendors matching their event needs with shareable filter URLs
Output: Sidebar-based filter UI, URL-synced filter state, availability-aware vendor queries
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-event-planning-discovery/03-CONTEXT.md
@.planning/phases/03-event-planning-discovery/03-RESEARCH.md

# Existing code to extend
@frontend/src/pages/VendorsPage.jsx
@frontend/src/hooks/useVendors.ts
@frontend/src/lib/metro-areas.ts
@frontend/src/lib/vendor-categories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDiscoveryFilters hook</name>
  <files>frontend/src/hooks/useDiscoveryFilters.ts</files>
  <action>
Create URL-synced filter state hook following RESEARCH.md Pattern 2:

```typescript
interface Filters {
  category: string
  location: string
  priceRange: string
  availableDate: string  // yyyy-MM-dd format
  search: string
}

export function useDiscoveryFilters() {
  const [searchParams, setSearchParams] = useSearchParams()

  const filters = useMemo<Filters>(() => ({
    category: searchParams.get('category') || '',
    location: searchParams.get('location') || '',
    priceRange: searchParams.get('price') || '',
    availableDate: searchParams.get('date') || '',
    search: searchParams.get('q') || '',
  }), [searchParams])

  const setFilter = (key: keyof Filters, value: string) => {
    const newParams = new URLSearchParams(searchParams)
    const paramKey = key === 'search' ? 'q' :
                     key === 'priceRange' ? 'price' :
                     key === 'availableDate' ? 'date' : key
    if (value) {
      newParams.set(paramKey, value)
    } else {
      newParams.delete(paramKey)
    }
    setSearchParams(newParams)
  }

  const clearFilters = () => setSearchParams({})

  const hasActiveFilters = Object.values(filters).some(v => v !== '')

  return { filters, setFilter, clearFilters, hasActiveFilters }
}
```

This hook:
- Reads all filter values from URL search params
- Provides setFilter to update individual filters
- Provides clearFilters to reset all
- hasActiveFilters boolean for "Clear all" button visibility
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>useDiscoveryFilters syncs filter state with URL search params</done>
</task>

<task type="auto">
  <name>Task 2: Extend useVendors with availability filter</name>
  <files>frontend/src/hooks/useVendors.ts</files>
  <action>
Extend existing useVendors hook to support:
1. Location filter (filter by service_areas array)
2. Availability date filter (exclude vendors blocked on that date)

**Update UseVendorsParams interface:**
```typescript
interface UseVendorsParams {
  category?: string
  search?: string
  price_range?: string
  location?: string        // NEW: metro area code
  availableDate?: string   // NEW: yyyy-MM-dd format
}
```

**Update query function:**
1. Add location filter:
```typescript
if (params.location) {
  query = query.contains('service_areas', [params.location])
}
```

2. Add availability filter (after main query):
```typescript
if (params.availableDate) {
  // Fetch blocked vendors for this date
  const { data: blockedVendors } = await supabase
    .from('vendor_availability')
    .select('vendor_id')
    .eq('blocked_date', params.availableDate)

  const blockedIds = new Set(blockedVendors?.map(b => b.vendor_id) || [])
  vendors = vendors.filter(v => !blockedIds.has(v.id))
}
```

This avoids N+1 queries by:
- First fetching all matching vendors
- Then batch-fetching blocked vendor IDs for the date
- Client-side filtering (efficient for typical result sets)

Update queryKey to include all params for proper cache invalidation.
  </action>
  <verify>TypeScript compiles, no errors in useVendors</verify>
  <done>useVendors supports location and availableDate filters</done>
</task>

<task type="auto">
  <name>Task 3: Create FilterSidebar and rebuild VendorsPage</name>
  <files>
    frontend/src/components/discovery/FilterSidebar.tsx
    frontend/src/components/discovery/VendorGrid.tsx
    frontend/src/pages/VendorsPage.jsx
  </files>
  <action>
**FilterSidebar.tsx:**
Left sidebar with filter sections:

```typescript
interface FilterSidebarProps {
  filters: Filters
  setFilter: (key: keyof Filters, value: string) => void
  clearFilters: () => void
  hasActiveFilters: boolean
}
```

Sections:
1. **Header** - "Filters" title + "Clear all" button (visible when hasActiveFilters)

2. **Category** - Select dropdown from VENDOR_CATEGORIES
   - Option: "All Categories" (value: "")
   - Show category icons in options

3. **Location** - Select dropdown from METRO_AREAS
   - Option: "All Locations" (value: "")

4. **Price Range** - Select dropdown
   - Options: All Prices, $ Budget, $$ Moderate, $$$ Premium, $$$$ Luxury

5. **Available On** - Date picker using react-day-picker
   - Calendar in Popover (like event wizard)
   - Clear button to remove date filter
   - Format selected date as "Available on Mar 15, 2026"

Styling: Sticky sidebar (top-24 for navbar clearance), bg-white, rounded-xl, shadow-sm

**VendorGrid.tsx:**
Simple grid wrapper component:
```typescript
interface VendorGridProps {
  vendors: PublicVendor[]
  isLoading: boolean
}
```
- Show loading skeleton when isLoading
- Show vendors in bento-grid (existing class)
- Show empty state when no results

**VendorsPage.jsx (REBUILD):**
New layout structure:
```jsx
<div className="flex gap-6">
  {/* Left Sidebar - hidden on mobile, sticky on desktop */}
  <aside className="w-64 shrink-0 hidden lg:block">
    <FilterSidebar
      filters={filters}
      setFilter={setFilter}
      clearFilters={clearFilters}
      hasActiveFilters={hasActiveFilters}
    />
  </aside>

  {/* Main Content */}
  <main className="flex-1">
    {/* Mobile filter button + search bar */}
    {/* Results count */}
    {/* VendorGrid */}
  </main>
</div>
```

Keep existing:
- Navbar
- Page header
- Category tabs (now above the flex layout, horizontal scroll)
- Search input (in main area, above grid)
- AIChat floating button

Remove duplicate filter controls that are now in sidebar.

Mobile: Hide sidebar, show mobile filter button that opens Sheet with filters.
  </action>
  <verify>
Visit /vendors - sidebar visible on desktop, filters work, URL updates
Share URL with filters - recipient sees same filtered results
  </verify>
  <done>
VendorsPage has sidebar layout, all 5 filters work, URL state persists
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Visit /vendors - see sidebar on left with 4 filter sections
2. Select category - URL updates to ?category=venue, results filter
3. Select location - URL updates to ?location=bay_area
4. Select price range - URL updates to ?price=$$
5. Pick availability date - URL updates to ?date=2026-03-15
6. Search vendors - URL updates to ?q=searchterm
7. Combine multiple filters - all appear in URL
8. Copy URL, open in new tab - same filters applied
9. Click "Clear all" - URL clears, all vendors shown
</verification>

<success_criteria>
- Sidebar visible on desktop (lg:), hidden on mobile
- All 5 filters functional: category, location, price, date, search
- Filter state synced to URL search params
- Availability filter excludes vendors blocked on selected date
- Shareable URLs work (filters applied on page load)
- Mobile has accessible filter controls (Sheet or drawer)
</success_criteria>

<output>
After completion, create `.planning/phases/03-event-planning-discovery/03-03-SUMMARY.md`
</output>
