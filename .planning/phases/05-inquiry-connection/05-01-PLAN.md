---
phase: 05-inquiry-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00004_inquiry_tables.sql
  - frontend/src/lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "Inquiries table exists with proper foreign keys"
    - "RLS policies enforce user can only see own inquiries"
    - "RLS policies enforce vendor can only see inquiries sent to them"
    - "Vendor can only respond to pending inquiries"
    - "Contact fields exist on vendor_profiles"
  artifacts:
    - path: "supabase/migrations/00004_inquiry_tables.sql"
      provides: "Inquiries table with RLS policies"
      contains: "CREATE TABLE public.inquiries"
    - path: "frontend/src/lib/database.types.ts"
      provides: "TypeScript types for inquiries"
      contains: "inquiries"
  key_links:
    - from: "inquiries.user_id"
      to: "profiles.id"
      via: "foreign key"
    - from: "inquiries.vendor_id"
      to: "vendor_profiles.id"
      via: "foreign key"
    - from: "inquiries.event_id"
      to: "events.id"
      via: "foreign key"
---

<objective>
Create database schema for inquiry system with proper RLS security.

Purpose: Enable secure user-vendor inquiry storage with status tracking
Output: Migration file with inquiries table, RLS policies, and contact field additions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-inquiry-connection/05-CONTEXT.md
@.planning/phases/05-inquiry-connection/05-RESEARCH.md

Existing migration patterns:
@supabase/migrations/00002_vendor_tables.sql
@supabase/migrations/00003_event_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create inquiries table migration</name>
  <files>supabase/migrations/00004_inquiry_tables.sql</files>
  <action>
Create migration file following existing patterns from 00002/00003.

Table: public.inquiries
- id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
- user_id: UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
- vendor_id: UUID NOT NULL REFERENCES vendor_profiles(id) ON DELETE CASCADE
- event_id: UUID NOT NULL REFERENCES events(id) ON DELETE CASCADE
- message: TEXT (optional user note)
- status: TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined'))
- response_message: TEXT (vendor's response)
- responded_at: TIMESTAMPTZ
- user_read_at: TIMESTAMPTZ (for unread badge)
- vendor_read_at: TIMESTAMPTZ (for unread badge)
- created_at: TIMESTAMPTZ DEFAULT NOW()
- updated_at: TIMESTAMPTZ DEFAULT NOW()
- UNIQUE(user_id, vendor_id, event_id) -- prevent duplicate inquiries

Indexes:
- idx_inquiries_user_id ON inquiries(user_id)
- idx_inquiries_vendor_id ON inquiries(vendor_id)
- idx_inquiries_status ON inquiries(status)
- idx_inquiries_created_at ON inquiries(created_at DESC)

RLS Policies:
1. "Users can view own inquiries" - SELECT WHERE auth.uid() = user_id
2. "Vendors can view received inquiries" - SELECT WHERE auth.uid() = vendor_id
3. "Users can send inquiries" - INSERT WITH CHECK auth.uid() = user_id
4. "Users can mark inquiries read" - UPDATE on user_read_at only
5. "Vendors can respond to inquiries" - UPDATE WHERE auth.uid() = vendor_id AND status = 'pending', can only set status to accepted/declined

Add trigger for updated_at using existing handle_updated_at function.

Also add contact fields to vendor_profiles if not present:
- contact_email TEXT
- contact_phone TEXT
  </action>
  <verify>
Run: `supabase db diff` or manually review SQL syntax
Check: All foreign keys reference correct tables
Check: RLS policies prevent unauthorized access
  </verify>
  <done>
Migration file exists with inquiries table, all indexes, RLS policies, updated_at trigger, and contact field additions to vendor_profiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types</name>
  <files>frontend/src/lib/database.types.ts</files>
  <action>
Add Inquiry type definitions to database.types.ts:

```typescript
export interface Inquiry {
  id: string
  user_id: string
  vendor_id: string
  event_id: string
  message: string | null
  status: 'pending' | 'accepted' | 'declined'
  response_message: string | null
  responded_at: string | null
  user_read_at: string | null
  vendor_read_at: string | null
  created_at: string
  updated_at: string
}

export interface InquiryInsert {
  user_id: string
  vendor_id: string
  event_id: string
  message?: string | null
}

export interface InquiryUpdate {
  status?: 'accepted' | 'declined'
  response_message?: string | null
  responded_at?: string
  user_read_at?: string
  vendor_read_at?: string
}
```

Add to vendor_profiles type if not present:
- contact_email: string | null
- contact_phone: string | null
  </action>
  <verify>
Run: `npm run type-check` or `tsc --noEmit` in frontend directory
Check: No TypeScript errors
  </verify>
  <done>
Inquiry types exported from database.types.ts, vendor_profiles includes contact fields
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file exists at supabase/migrations/00004_inquiry_tables.sql
- [ ] Inquiries table has all required columns and constraints
- [ ] RLS policies enforce security boundaries
- [ ] TypeScript types match database schema
- [ ] No TypeScript compilation errors
</verification>

<success_criteria>
Database schema ready for inquiry CRUD operations with proper security. Types available for frontend hooks.
</success_criteria>

<output>
After completion, create `.planning/phases/05-inquiry-connection/05-01-SUMMARY.md`
</output>
