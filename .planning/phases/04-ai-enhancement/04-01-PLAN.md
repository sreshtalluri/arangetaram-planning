---
phase: 04-ai-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/_shared/claude-client.ts
  - supabase/functions/_shared/prompts/chat-system.ts
  - supabase/functions/_shared/prompts/recommendation.ts
  - supabase/functions/ai-chat/index.ts
  - supabase/functions/ai-recommendations/index.ts
autonomous: false
user_setup:
  - service: anthropic
    why: "Claude API for AI recommendations and chat"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"
    dashboard_config:
      - task: "Add ANTHROPIC_API_KEY to Supabase Edge Function secrets"
        location: "Supabase Dashboard -> Project Settings -> Edge Functions -> Secrets"

must_haves:
  truths:
    - "Edge function ai-chat streams Claude responses via SSE"
    - "Edge function ai-recommendations returns ranked vendors with explanations"
    - "Prompt caching is enabled for system prompts (cost optimization)"
  artifacts:
    - path: "supabase/functions/_shared/claude-client.ts"
      provides: "Anthropic SDK client factory"
      exports: ["createClaudeClient"]
    - path: "supabase/functions/_shared/prompts/chat-system.ts"
      provides: "Chat assistant system prompt"
      exports: ["CHAT_SYSTEM_PROMPT"]
    - path: "supabase/functions/_shared/prompts/recommendation.ts"
      provides: "Recommendation ranking prompt"
      exports: ["RECOMMENDATION_SYSTEM_PROMPT"]
    - path: "supabase/functions/ai-chat/index.ts"
      provides: "Streaming chat endpoint"
      contains: "Deno.serve"
    - path: "supabase/functions/ai-recommendations/index.ts"
      provides: "Hybrid recommendation endpoint"
      contains: "Deno.serve"
  key_links:
    - from: "supabase/functions/ai-chat/index.ts"
      to: "Anthropic SDK"
      via: "createClaudeClient import"
      pattern: "import.*claude-client"
    - from: "supabase/functions/ai-recommendations/index.ts"
      to: "vendor_profiles table"
      via: "Supabase query before AI ranking"
      pattern: "from\\('vendor_profiles'\\)"
---

<objective>
Create Supabase Edge Functions for AI chat (streaming) and recommendations (hybrid filter + AI ranking).

Purpose: Backend AI infrastructure that the frontend will call. Edge Functions keep API keys secure and handle CORS.
Output: Two deployed Edge Functions (ai-chat, ai-recommendations) with shared Claude client and prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-ai-enhancement/04-CONTEXT.md
@.planning/phases/04-ai-enhancement/04-RESEARCH.md
@supabase/config.toml
@frontend/src/hooks/useEvents.ts
@frontend/src/hooks/useVendors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Claude client and prompts</name>
  <files>
    supabase/functions/_shared/claude-client.ts
    supabase/functions/_shared/prompts/chat-system.ts
    supabase/functions/_shared/prompts/recommendation.ts
  </files>
  <action>
  Create the shared directory structure for Edge Functions:

  **supabase/functions/_shared/claude-client.ts:**
  - Export `createClaudeClient()` factory function that:
    - Imports Anthropic from `npm:@anthropic-ai/sdk@^0.27.0`
    - Gets API key from `Deno.env.get('ANTHROPIC_API_KEY')`
    - Returns configured Anthropic client instance
  - Export CORS headers constant for reuse:
    ```typescript
    export const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
    }
    ```

  **supabase/functions/_shared/prompts/chat-system.ts:**
  - Export `CHAT_SYSTEM_PROMPT` string using XML structure:
    - `<role>`: Arangetram planning assistant
    - `<behavior>`: Concise (2-4 sentences), factual tone, ask clarifying questions
    - `<knowledge>`: Typical budget $15k-50k, key categories, 8-12 month planning timeline, Bay Area focus
    - `<constraints>`: Don't make up vendor names, don't promise availability, recommend using vendor discovery

  **supabase/functions/_shared/prompts/recommendation.ts:**
  - Export `RECOMMENDATION_SYSTEM_PROMPT` string that instructs Claude to:
    - Rank vendor candidates by fit for the event
    - Return top 3 per category
    - Provide 1-2 sentence explanation for each (factual: budget match, location, availability)
    - Use JSON output format with structure: `{ categories: { [category]: { vendors: [{ id, explanation }] } } }`
  </action>
  <verify>
  Files exist and export correctly:
  ```bash
  cat supabase/functions/_shared/claude-client.ts | grep "export"
  cat supabase/functions/_shared/prompts/chat-system.ts | grep "CHAT_SYSTEM_PROMPT"
  cat supabase/functions/_shared/prompts/recommendation.ts | grep "RECOMMENDATION_SYSTEM_PROMPT"
  ```
  </verify>
  <done>Shared Claude client factory and prompts exist in _shared directory</done>
</task>

<task type="auto">
  <name>Task 2: Create ai-chat Edge Function with streaming</name>
  <files>supabase/functions/ai-chat/index.ts</files>
  <action>
  Create the chat Edge Function with SSE streaming:

  **supabase/functions/ai-chat/index.ts:**
  - Import Deno.serve from std http
  - Import createClaudeClient and corsHeaders from ../_shared/claude-client.ts
  - Import CHAT_SYSTEM_PROMPT from ../_shared/prompts/chat-system.ts

  Handle CORS preflight (OPTIONS request -> return 200 with corsHeaders)

  Main handler:
  1. Parse JSON body: `{ message: string, eventContext?: Event, history?: Message[] }`
  2. Get Anthropic client via createClaudeClient()
  3. Build messages array:
     - If eventContext provided, prepend user message with event details (date, budget, location, categories)
     - Include last 10 messages from history
     - Add current message
  4. Call `anthropic.messages.stream()` with:
     - model: 'claude-sonnet-4-5-20250929'
     - max_tokens: 1024
     - system: `[{ type: 'text', text: CHAT_SYSTEM_PROMPT, cache_control: { type: 'ephemeral' } }]`
     - messages array
  5. Create ReadableStream that:
     - Iterates over stream events
     - On 'content_block_delta', writes `data: ${JSON.stringify({ text })}\n\n`
     - On completion, writes `data: [DONE]\n\n` and closes
  6. Return Response with body=stream, Content-Type: text/event-stream, corsHeaders

  Error handling: Catch errors, return 500 with JSON error message and corsHeaders
  </action>
  <verify>
  Function file exists with correct structure:
  ```bash
  cat supabase/functions/ai-chat/index.ts | grep -E "(Deno.serve|messages.stream|text/event-stream)"
  ```
  </verify>
  <done>ai-chat Edge Function exists with SSE streaming to Claude</done>
</task>

<task type="auto">
  <name>Task 3: Create ai-recommendations Edge Function with hybrid approach</name>
  <files>supabase/functions/ai-recommendations/index.ts</files>
  <action>
  Create the recommendations Edge Function with hybrid filter + AI ranking:

  **supabase/functions/ai-recommendations/index.ts:**
  - Import Deno.serve, createClient from @supabase/supabase-js
  - Import createClaudeClient, corsHeaders from ../_shared/claude-client.ts
  - Import RECOMMENDATION_SYSTEM_PROMPT from ../_shared/prompts/recommendation.ts

  Handle CORS preflight

  Main handler:
  1. Parse JSON body: `{ eventId: string }`
  2. Get auth token from Authorization header
  3. Create Supabase client with service role key (from env)

  **Step 1 - Fetch event:**
  - Query events table by eventId to get: event_date, location, budget, categories_needed
  - Return 404 if not found

  **Step 2 - Database filter (fast, cheap):**
  - Query vendor_profiles where:
    - is_published = true
    - category IN event.categories_needed
    - service_areas contains event.location (if specified)
    - price_min <= event.budget (if specified)
  - Also check vendor_availability to exclude blocked vendors for event_date
  - Limit to 10 candidates per category (to keep AI costs low)

  **Step 3 - AI ranking (intelligent):**
  - Call anthropic.messages.create() with:
    - model: 'claude-sonnet-4-5-20250929'
    - max_tokens: 2048
    - system: `[{ type: 'text', text: RECOMMENDATION_SYSTEM_PROMPT, cache_control: { type: 'ephemeral' } }]`
    - messages: User message with JSON of event context + candidate vendors
  - Parse JSON response to get ranked vendors with explanations

  **Step 4 - Return enriched results:**
  - Map AI rankings back to full vendor data
  - Return JSON: `{ categories: { [category]: { vendors: [{ ...vendorData, aiExplanation }] } } }`

  Error handling: Catch errors, return appropriate status codes
  </action>
  <verify>
  Function file exists with hybrid approach:
  ```bash
  cat supabase/functions/ai-recommendations/index.ts | grep -E "(from\\('vendor_profiles'\\)|from\\('events'\\)|messages.create)"
  ```
  </verify>
  <done>ai-recommendations Edge Function exists with database filter then AI ranking</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Two Supabase Edge Functions for AI chat and recommendations</what-built>
  <how-to-verify>
  1. Add ANTHROPIC_API_KEY to Supabase secrets:
     - Go to Supabase Dashboard -> Project Settings -> Edge Functions -> Secrets
     - Add secret: ANTHROPIC_API_KEY = [your Anthropic API key]

  2. Deploy Edge Functions:
     ```bash
     cd /Users/sreshtalluri/Documents/Github/arangetaram-planning
     npx supabase functions deploy ai-chat
     npx supabase functions deploy ai-recommendations
     ```

  3. Test ai-chat function (should stream response):
     ```bash
     curl -N -X POST 'https://[project-ref].supabase.co/functions/v1/ai-chat' \
       -H 'Content-Type: application/json' \
       -H 'Authorization: Bearer [anon-key]' \
       -d '{"message": "What should I budget for catering?"}'
     ```

  4. Verify streaming works (words appear one by one in response)

  Expected: SSE stream with `data: {"text":"..."}` chunks, ending with `data: [DONE]`
  </how-to-verify>
  <resume-signal>Type "approved" to continue or describe any issues with deployment</resume-signal>
</task>

</tasks>

<verification>
- [ ] supabase/functions/_shared/claude-client.ts exports createClaudeClient and corsHeaders
- [ ] supabase/functions/_shared/prompts/chat-system.ts exports CHAT_SYSTEM_PROMPT
- [ ] supabase/functions/_shared/prompts/recommendation.ts exports RECOMMENDATION_SYSTEM_PROMPT
- [ ] supabase/functions/ai-chat/index.ts uses streaming with SSE
- [ ] supabase/functions/ai-recommendations/index.ts does database filter then AI ranking
- [ ] Both functions handle CORS preflight
- [ ] Both functions use prompt caching (cache_control: { type: 'ephemeral' })
</verification>

<success_criteria>
Edge Functions deployed and responding:
- ai-chat returns streaming SSE response
- ai-recommendations returns JSON with ranked vendors
- ANTHROPIC_API_KEY is set in Supabase secrets
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-enhancement/04-01-SUMMARY.md`
</output>
